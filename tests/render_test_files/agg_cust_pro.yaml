variables:
  row_count: 1000
  dataset: sandbox_refined_stage_one_ingestion
  table: refined_ingestion
tables:
  - name: aggregated_customer_progress
    rows: {{ row_count }}
    targets:
      # - target: debug
      # - target: bigquery
      #   dataset: {{ dataset }}
      #   table: {{ table }}
    #output_columns: [source_name, source_id, ingestion_timestamp, message_timestamp]
    output_columns: [metadata_body, schema_body]
    columns:

    ### 
    ### WIP only a subet of columns implemented
    ###

    - col: source_name Fixed String data.internal.bet.gprom_aggregated_customer_progress_archived
    - col: source_id Random String 4 6
    - col: ingestion_timestamp Random Timestamp '{{ start }}' '{{ end }}'
    - col: message_timestamp Random Timestamp '{{ start }}' '{{ end }}'

    #- col: kafka.timestamp Random TimestampAsInt {{ start }} {{ end }}
    - col: kafka.topic Fixed String data.internal.bet.gprom_aggregated_customer_progress_archived
    - col: kafka.partition Random Int 0 5
    - col: kafka.offset Sequential Int 0 1

    - col: metadata_body Map
      source_columns: [kafka.topic, kafka.partition, kafka.offset]

    - col: schema_body Fixed String
      value: '{"type": "struct"}'

    # ################ message_body ################

    - col: customer_id Random Int 10000 50000
    - col: promotion_id Random String 4 4

    ######## promotion_progress #########

    #### StakeXGetYProgress ####

    - col: stakes_to_y Random Float 0.0 10.0
      decimal_places: 1

    - col: StakeXGetYProgress Map
      source_columns: [stakes_to_y]


    #### PlaybackProgress ####

    - col: number_of_spins Random Int 0 10
    - col: net_position Random Float 0.0 100.0
      decimal_places: 1
    - col: minimum_spins_met Selection
      values: [true, false]

    - col: PlaybackProgress Map
      source_columns: [number_of_spins, net_position, minimum_spins_met]

    
    #### LadderProgress ####

    - col: current_points Random Float 0 10
      decimal_places: 1
    - col: current_level Random Int 0 10
    - col: points_to_next_level Random Float 0.0 10.0
      decimal_places: 1
    - col: remaining_levels Random Int 0 10

    #### LadderProgress.next_reward ####
    - col: threshold Random Int 0 10
    - col: reward_amount Random Float 0.0 10.0
      decimal_places: 1
    - col: reward_type Selection String
      values:
        - None
        - FreeSpins
        - Cash
        - PrizeDrawTickets

    - col: next_reward Map
      source_columns: [threshold, reward_amount, reward_type]

    - col: LadderProgress Map
      source_columns: [current_points, current_level, points_to_next_level, remaining_levels, next_reward]


    #################### PrizeMachineProgress #######################

    - col: total_spin_count Random Int 10 30
    - col: mega Selection
      values: [true, false]

    #################### PrizeMachineProgress.today_spin ########
    - col: spin_id Random String 12 16
    - col: spin_time Random TimestampAsInt
      min: {{ start }}
      max: {{ end }}
    - col: win Selection
      values: [true, false]

    - col: today_spin Map
      source_columns: [spin_id, spin_time, win]

    - col: tomorrow_mega Selection
      values: [true, false]
     
    - col: PrizeMachineProgress Map
      source_columns: [total_spin_count, mega, today_spin, tomorrow_mega]


    #################### InplayCashbackProgress #######################

    - col: current_net_position Random Float 0.0 100.0
      decimal_places: 1
    - col: expected_return Random Float 0.0 100.0
      decimal_places: 1
    - col: max_return Random Float 0.0 100.0
      decimal_places: 1
    - col: min_return Random Float 0.0 100.0
      decimal_places: 1
    - col: percentage_cashback Random Float 0.0 100.0
      decimal_places: 1

    - col: InplayCashbackProgress Map
      source_columns: [current_net_position, expected_return, max_return, min_return, percentage_cashback]


    #################### TurnoverProgress #######################

    - col: aggregated_stake_amount Random Float 0.0 100.0
      decimal_places: 1
    - col: required_stake_amount Random Float 0.0 100.0
      decimal_places: 1
    - col: num_of_stakes Random Int 0 10

    - col: TurnoverProgress Map
      source_columns: [aggregated_stake_amount, required_stake_amount, num_of_stakes]


    #################### BetXGetYProgress #######################
      

    - col: BetXGetYProgress Map
      source_columns: [aggregated_stake_amount, required_stake_amount, num_of_stakes]

    
    #################### AcquisitionProgress #######################
      # get columns from TurnoverProgress above

    - col: first_deposit_completed Selection
      values: [true, false]

    - col: AcquisitionProgress Map
      source_columns: [required_stake_amount, num_of_stakes, first_deposit_completed]


    - col: promotion_progress Map
      select_one: true
      source_columns: [StakeXGetYProgress, PlaybackProgress, LadderProgress, PrizeMachineProgress, InplayCashbackProgress, TurnoverProgress, BetXGetYProgress, AcquisitionProgress]
      null_percentage: 10

    - col: message_body Map
      source_columns: [customer_id, promotion_id, promotion_progress] 